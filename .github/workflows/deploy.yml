name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
      
      - name: Sync files with rsync
        run: |
          rsync -avz --delete \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='.env' \
            --exclude='.env.*' \
            --exclude='.git' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            backend/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/backend-deploy/
      
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: false
          script: |
            # Usar shell nÃ£o-interativo para evitar erros do .bashrc
            export BASH_ENV=""
            set +e
            
            echo "ğŸš€ Iniciando deploy do backend..."
            
            # Tentar encontrar o diretÃ³rio do backend
            BACKEND_DIR="/opt/apps/cursos_plataform/backend"
            if [ ! -d "$BACKEND_DIR" ]; then
              BACKEND_DIR="/opt/storylinker/cursos_plataform/backend"
            fi
            if [ ! -d "$BACKEND_DIR" ]; then
              BACKEND_DIR=$(find /opt /home /var/www -type d -name "backend" 2>/dev/null | grep -i cursos | head -1)
            fi
            
            if [ -z "$BACKEND_DIR" ] || [ ! -d "$BACKEND_DIR" ]; then
              echo "âŒ DiretÃ³rio do backend nÃ£o encontrado!"
              exit 1
            fi
            
            echo "âœ… DiretÃ³rio encontrado: $BACKEND_DIR"
            cd "$BACKEND_DIR"
            
            # Sincronizar arquivos do /tmp para o diretÃ³rio do backend
            echo "ğŸ“¦ Sincronizando arquivos..."
            if [ -d "/tmp/backend-deploy" ]; then
              # Fazer backup dos arquivos importantes
              if [ -f ".env" ]; then
                cp .env .env.backup.$(date +%Y%m%d_%H%M%S) || true
              fi
              
              # Copiar arquivos (preservando .env e outros arquivos importantes)
              echo "ğŸ“‹ Copiando arquivos de /tmp/backend-deploy para $BACKEND_DIR..."
              rsync -av --exclude='.env' --exclude='.env.*' --exclude='node_modules' --exclude='dist' --exclude='.git' /tmp/backend-deploy/ "$BACKEND_DIR/" || {
                echo "âš ï¸  Rsync falhou, tentando cp..."
                cp -r /tmp/backend-deploy/* "$BACKEND_DIR/" 2>/dev/null || true
              }
              
              # Limpar arquivos temporÃ¡rios
              rm -rf /tmp/backend-deploy
              echo "âœ… Arquivos sincronizados"
            else
              echo "âŒ DiretÃ³rio /tmp/backend-deploy nÃ£o encontrado!"
              echo "âš ï¸  O rsync pode ter falhado. Verificando se podemos continuar..."
              # NÃ£o falhar aqui, apenas avisar
            fi
            
            # Verificar se a rota estÃ¡ presente
            echo "ğŸ” Verificando se a rota create-checkout-session existe..."
            if grep -q "create-checkout-session" routes/checkout.routes.js 2>/dev/null; then
              echo "âœ… Rota encontrada em routes/checkout.routes.js"
            elif grep -q "create-checkout-session" src/routes/checkout.routes.ts 2>/dev/null; then
              echo "âœ… Rota encontrada em src/routes/checkout.routes.ts"
            else
              echo "âš ï¸  Rota nÃ£o encontrada nos arquivos!"
            fi
            
            # Instalar dependÃªncias
            echo "ğŸ“¦ Instalando dependÃªncias..."
            npm install --production=false
            
            # Fazer build se usar TypeScript
            if [ -f "tsconfig.json" ]; then
              echo "ğŸ”¨ Fazendo build TypeScript..."
              npm run build
              
              # Verificar se a rota estÃ¡ no arquivo compilado
              if [ -f "dist/routes/checkout.routes.js" ]; then
                if grep -q "create-checkout-session" dist/routes/checkout.routes.js; then
                  echo "âœ… Rota encontrada no arquivo compilado"
                else
                  echo "âš ï¸  Rota nÃ£o encontrada no arquivo compilado!"
                fi
              fi
            fi
            
            # Encontrar o processo PM2
            echo "ğŸ“Š Verificando processos PM2..."
            PM2_APP=$(pm2 list | grep -E "cursos-api|backend" | awk '{print $2}' | head -1)
            
            if [ -z "$PM2_APP" ]; then
              echo "âš ï¸  Processo PM2 nÃ£o encontrado. Listando todos os processos:"
              pm2 list
              echo "âŒ NÃ£o foi possÃ­vel reiniciar o PM2 automaticamente"
              exit 1
            fi
            
            echo "âœ… Processo PM2 encontrado: $PM2_APP"
            
            # Mostrar qual arquivo estÃ¡ rodando
            echo "ğŸ“‹ InformaÃ§Ãµes do processo:"
            pm2 show "$PM2_APP" | grep -E "script|exec_mode|status" || true
            
            # Reiniciar PM2
            echo "ğŸ”„ Reiniciando PM2..."
            pm2 restart "$PM2_APP" --update-env
            
            # Aguardar um pouco para o processo iniciar
            sleep 3
            
            # Verificar status
            echo "ğŸ“Š Status do PM2:"
            pm2 status
            
            # Mostrar Ãºltimas linhas do log
            echo "ğŸ“‹ Ãšltimas linhas do log:"
            pm2 logs "$PM2_APP" --lines 10 --nostream || true
            
            echo "âœ… Deploy concluÃ­do com sucesso!"
