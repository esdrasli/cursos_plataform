name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e  # Parar em caso de erro
            
            echo "ğŸš€ Iniciando deploy do backend..."
            
            # Tentar encontrar o diretÃ³rio do backend
            BACKEND_DIR="/opt/apps/cursos_plataform/backend"
            if [ ! -d "$BACKEND_DIR" ]; then
              BACKEND_DIR="/opt/storylinker/cursos_plataform/backend"
            fi
            if [ ! -d "$BACKEND_DIR" ]; then
              BACKEND_DIR=$(find /opt /home /var/www -type d -name "backend" 2>/dev/null | grep -i cursos | head -1)
            fi
            
            if [ -z "$BACKEND_DIR" ] || [ ! -d "$BACKEND_DIR" ]; then
              echo "âŒ DiretÃ³rio do backend nÃ£o encontrado!"
              exit 1
            fi
            
            echo "âœ… DiretÃ³rio encontrado: $BACKEND_DIR"
            cd "$BACKEND_DIR"
            
            # Verificar status do git antes do pull
            echo "ğŸ“‹ Status do git antes do pull:"
            git status --short || true
            
            # Fazer pull do cÃ³digo
            echo "ğŸ“¥ Fazendo pull do repositÃ³rio..."
            git fetch origin main
            git pull origin main || {
              echo "âš ï¸  Git pull falhou, tentando reset hard..."
              git reset --hard origin/main
            }
            
            # Verificar se a rota estÃ¡ presente
            echo "ğŸ” Verificando se a rota create-checkout-session existe..."
            if grep -q "create-checkout-session" routes/checkout.routes.js 2>/dev/null; then
              echo "âœ… Rota encontrada em routes/checkout.routes.js"
            elif grep -q "create-checkout-session" src/routes/checkout.routes.ts 2>/dev/null; then
              echo "âœ… Rota encontrada em src/routes/checkout.routes.ts"
            else
              echo "âš ï¸  Rota nÃ£o encontrada nos arquivos!"
            fi
            
            # Instalar dependÃªncias
            echo "ğŸ“¦ Instalando dependÃªncias..."
            npm install --production=false
            
            # Fazer build se usar TypeScript
            if [ -f "tsconfig.json" ]; then
              echo "ğŸ”¨ Fazendo build TypeScript..."
              npm run build
              
              # Verificar se a rota estÃ¡ no arquivo compilado
              if [ -f "dist/routes/checkout.routes.js" ]; then
                if grep -q "create-checkout-session" dist/routes/checkout.routes.js; then
                  echo "âœ… Rota encontrada no arquivo compilado"
                else
                  echo "âš ï¸  Rota nÃ£o encontrada no arquivo compilado!"
                fi
              fi
            fi
            
            # Encontrar o processo PM2
            echo "ğŸ“Š Verificando processos PM2..."
            PM2_APP=$(pm2 list | grep -E "cursos-api|backend" | awk '{print $2}' | head -1)
            
            if [ -z "$PM2_APP" ]; then
              echo "âš ï¸  Processo PM2 nÃ£o encontrado. Listando todos os processos:"
              pm2 list
              echo "âŒ NÃ£o foi possÃ­vel reiniciar o PM2 automaticamente"
              exit 1
            fi
            
            echo "âœ… Processo PM2 encontrado: $PM2_APP"
            
            # Mostrar qual arquivo estÃ¡ rodando
            echo "ğŸ“‹ InformaÃ§Ãµes do processo:"
            pm2 show "$PM2_APP" | grep -E "script|exec_mode|status" || true
            
            # Reiniciar PM2
            echo "ğŸ”„ Reiniciando PM2..."
            pm2 restart "$PM2_APP" --update-env
            
            # Aguardar um pouco para o processo iniciar
            sleep 3
            
            # Verificar status
            echo "ğŸ“Š Status do PM2:"
            pm2 status
            
            # Mostrar Ãºltimas linhas do log
            echo "ğŸ“‹ Ãšltimas linhas do log:"
            pm2 logs "$PM2_APP" --lines 10 --nostream || true
            
            echo "âœ… Deploy concluÃ­do com sucesso!"
